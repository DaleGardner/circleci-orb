description: >
  A single, complete job to run Cypress end-to-end tests in your application.
# What will this job do?
executor: default

parameters:
  install-command:
    description: Overrides the default NPM command (npm ci)
    type: string
    default: ""
  post-install:
    description: >
      Additional commands to run after running install
      but before verifying Cypress and saving cache.
    type: string
    default: ""
  cache-key:
    description: Cache key used to cache the Cypress binary.
    type: string
    default: 'cypress-cache-{{ arch }}-{{ checksum "package.json" }}'
  cache-path:
    description: |
      By default, this will cache the '~/.cache' directory so that the Cypress binary is cached. You can override this by providing your own cache path.
    type: string
    default: "~/.cache"
  node-cache-version:
    type: string
    default: "v1"
    description: Change the default node cache version if you need to clear the cache for any reason.
  working-directory:
    description: Directory containing package.json
    type: string
    default: ""
  package-manager:
    type: enum
    enum: ["npm", "yarn", "yarn-berry"]
    default: "npm"
    description: Select the default node package manager to use. NPM v5+ Required.
  start-command:
    description: Command used to start your local dev server for Cypress to tests against
    type: string
    default: ""
  cypress-command:
    description: Command used to run your Cypress tests
    type: string
    default: "npx cypress run"

steps:
  - checkout
  - restore_cache:
      name: Restore Cypress cache
      key: << parameters.cache-key >>
  - node/install-packages:
      override-ci-command: << parameters.install-command >>
      app-dir: << parameters.working-directory >>
      pkg-manager: << parameters.package-manager >>
      include-branch-in-cache-key: false
      cache-version: << parameters.node-cache-version >>
  - when:
      condition: << parameters.post-install >>
      steps:
        - run:
            name: Post Install Script
            command: << parameters.post-install >>
            working_directory: << parameters.working-directory >>
  - run:
      name: Verify Cypress
      command: "npx cypress verify"
      working_directory: << parameters.working-directory >>
  - when:
      condition: << parameters.start-command >>
      steps:
        - run:
            name: Start Server
            command: << parameters.start-command >>
            background: true
            working_directory: << parameters.working-directory >>
  - run:
      name: Run Cypress
      command: << parameters.cypress-command >>
      working_directory: << parameters.working-directory >>
  - store_artifacts:
      path: << parameters.working-directory >>/cypress/videos
  - store_artifacts:
      path: << parameters.working-directory >>/cypress/screenshots
  - save_cache:
      name: Save Cypress Binary
      key: << parameters.cache-key >>
      paths:
        - << parameters.cache-path >>
