version: 2.1
orbs:
  cypress: cypress-io/cypress@dev:<<pipeline.git.revision>>
  orb-tools: circleci/orb-tools@11.5
filters: &filters
  tags:
    only: /.*/

jobs:
  testing-kitchensink:
    docker:
      - image: 'cimg/node:lts'
    # steps:
    #   - run:
    #       name: "Checkout Kitchensink App"
    #       command: git clone https://github.com/cypress-io/cypress-example-kitchensink.git ~/project
    #   - run:
    #       name: "log dir"
    #       command: ls -l
    #   - persist_to_workspace:
    #       root: /home/circleci
    #       paths:
    #         - project

    steps:
      # - restore_cached_workspace
      - run:
          name: "Checkout Kitchensink App"
          working_directory: /tmp/cypress-example-kitchensink
          command: git clone --depth 1 --no-single-branch https://github.com/cypress-io/cypress-example-kitchensink.git .
      # - clone-repo-and-checkout-branch:
      #     repo: cypress-example-kitchensink
      # - install-required-node
      # - run:
      #     name: Remove cypress.json
      #     description: Remove cypress.json in case it exists
      #     working_directory: /tmp/cypress-example-kitchensink
      #     environment:
      #       CYPRESS_INTERNAL_FORCE_SCAFFOLD: "1"
      #     command: rm -rf cypress.json

      - run:
          name: "log dir"
          command: pwd
          command: ls

      - run:
          name: Install prod dependencies
          command: yarn --production
          working_directory: /tmp/cypress-example-kitchensink
      - run:
          name: Example server
          command: yarn start
          working_directory: /tmp/cypress-example-kitchensink
          background: true
      # - run:
      #     name: Rename support file
      #     working_directory: /tmp/cypress-example-kitchensink
      #     command: |
      #       if [[ -f cypress/support/index.js ]]; then
      #         mv cypress/support/index.js cypress/support/e2e.js
      #       fi
      - run:
          name: Run Kitchensink example project
          command: |
            yarn cypress:run --project /tmp/cypress-example-kitchensink
    
workflows:
  test-deploy:
    jobs:
      # Make sure to include "filters: *filters" in every test job you want to run as part of your deployment.
      - testing-kitchensink:
          filters: *filters
      - cypress/run:
          working-directory: ~/project
          requires:
            - testing-kitchensink
      - orb-tools/pack:
          filters: *filters
      - orb-tools/publish:
          orb-name: cypress-io/cypress
          vcs-type: << pipeline.project.type >>
          pub-type: production
          requires:
            - orb-tools/pack
            - testing-kitchensink
          context: circleci-orb-publishing
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v[0-9]+\.[0-9]+\.[0-9]+$/
